<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy Birthday ‚ù§Ô∏è</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Playfair Display',serif;
  color:white;
  text-align:center;
  overflow:hidden;
  background:#000;
}

/* ===== Ambient Background ===== */
body::before{
  content:"";
  position:fixed;
  top:-50%; left:-50%;
  width:200%; height:200%;
  background:radial-gradient(circle at 30% 30%, rgba(212,175,55,.15), transparent 40%);
  animation:ambientMove 18s linear infinite alternate;
  z-index:-2;
}
@keyframes ambientMove{
  from{transform:translate(0,0);}
  to{transform:translate(15%,15%);}
}

/* Floating particles */
.particle{
  position:fixed;
  width:3px;height:3px;
  background:gold;
  border-radius:50%;
  opacity:.4;
  animation:floatUp linear infinite;
  z-index:-1;
}
@keyframes floatUp{
  from{transform:translateY(100vh);opacity:0;}
  20%{opacity:.6;}
  to{transform:translateY(-10vh);opacity:0;}
}

/* ===== Layout ===== */
.container{
  position:absolute;
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  padding:20px;
}

.gold{color:#d4af37;}

button{
  padding:14px 20px;
  border-radius:40px;
  border:2px solid #d4af37;
  background:rgba(0,0,0,.4);
  color:#d4af37;
  font-weight:bold;
  margin:10px;
  cursor:pointer;
}

/* ===== Cake ===== */
.cake{position:relative;width:200px;height:230px;margin:20px auto;}
.cake-base{
  position:absolute;bottom:0;width:100%;height:100px;
  background:linear-gradient(#ffb6c1,#ff8fab);
  border-radius:20px;
}
.candle{
  position:absolute;width:12px;height:60px;background:white;
  left:50%;transform:translateX(-50%);
  bottom:100px;
}
.flame{
  position:absolute;width:18px;height:26px;
  left:50%;transform:translateX(-50%);
  bottom:160px;
  background:radial-gradient(circle,#ffd700 40%,orange 70%);
  border-radius:50%;
  transition:transform .1s, box-shadow .1s;
}

/* Smoke */
.smoke{
  position:absolute;
  width:12px;height:12px;
  background:rgba(200,200,200,.7);
  border-radius:50%;
  bottom:170px;
  left:50%;
  transform:translateX(-50%);
  animation:smokeRise 3s ease-out forwards;
}
@keyframes smokeRise{
  from{opacity:.8;transform:translate(-50%,0) scale(1);}
  to{opacity:0;transform:translate(-50%,-80px) scale(2);}
}

canvas{
  position:fixed;
  top:0;left:0;
  pointer-events:none;
}

.message{opacity:0;transition:opacity 2s;}
.show{opacity:1;}
</style>
</head>

<body>

<div class="container">
  <h1>Happy <span class="gold">30th</span> Birthday ‚ù§Ô∏è</h1>

  <div class="cake">
    <div class="cake-base"></div>
    <div class="candle"></div>
    <div class="flame" id="flame"></div>
  </div>

  <button id="blowBtn" onclick="startMicBlow()">Blow the Candle üé§üéÇ</button>
  <button id="retryBtn" style="display:none;" onclick="resetBlow()">Try Again üîÅ</button>

  <div class="message" id="message">
    With all my love ‚Äî Khalikul ‚ù§Ô∏è
  </div>
</div>

<canvas id="confetti"></canvas>

<audio id="bgMusic" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<script>

/* Floating particles */
for(let i=0;i<30;i++){
  let p=document.createElement("div");
  p.className="particle";
  p.style.left=Math.random()*100+"vw";
  p.style.animationDuration=(6+Math.random()*6)+"s";
  document.body.appendChild(p);
}

/* ================= MIC BLOW SYSTEM ================= */

let audioCtx;
let analyser;
let micSource;
let dataArray;
let blowing=false;
let blowTimeout;

async function startMicBlow(){
  try{
    blowing=false;
    blowBtn.innerText="Blow now... üí®";
    retryBtn.style.display="none";

    const stream=await navigator.mediaDevices.getUserMedia({audio:true});

    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.resume();

    analyser=audioCtx.createAnalyser();
    analyser.fftSize=1024;

    micSource=audioCtx.createMediaStreamSource(stream);
    micSource.connect(analyser);

    dataArray=new Uint8Array(analyser.fftSize);

    listenForBlow();

    blowTimeout=setTimeout(()=>{
      if(!blowing){
        stopMic();
        blowBtn.innerText="Too soft üòÖ";
        retryBtn.style.display="inline-block";
      }
    },5000);

  }catch(e){
    alert("Please allow microphone access üò¢");
  }
}

function listenForBlow(){
  analyser.getByteTimeDomainData(dataArray);

  let sum=0;
  for(let i=0;i<dataArray.length;i++){
    let val=(dataArray[i]-128)/128;
    sum+=val*val;
  }
  let volume=Math.sqrt(sum/dataArray.length);

  flame.style.transform=`translateX(-50%) scale(${1+volume*3})`;
  flame.style.boxShadow=`0 0 ${volume*80}px gold`;

  if(volume>0.18){
    blowing=true;
    clearTimeout(blowTimeout);
    stopMic();
    extinguish();
    return;
  }

  if(!blowing) requestAnimationFrame(listenForBlow);
}

function stopMic(){
  if(micSource) micSource.disconnect();
  if(audioCtx) audioCtx.close();
}

function resetBlow(){
  blowBtn.innerText="Blow the Candle üé§üéÇ";
  retryBtn.style.display="none";
}

/* ================= EXTINGUISH ================= */

function extinguish(){
  flame.style.display="none";
  createSmoke();
  startConfetti();
  fadeMusicIn();
  message.classList.add("show");
}

function createSmoke(){
  for(let i=0;i<5;i++){
    let s=document.createElement("div");
    s.className="smoke";
    s.style.animationDelay=i*0.3+"s";
    document.querySelector(".cake").appendChild(s);
    setTimeout(()=>s.remove(),3000);
  }
}

/* ================= CONFETTI ================= */

const canvas=document.getElementById("confetti");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

let confetti=[];
function startConfetti(){
  for(let i=0;i<180;i++){
    confetti.push({
      x:canvas.width/2,
      y:canvas.height/2,
      vx:(Math.random()-0.5)*10,
      vy:(Math.random()-0.5)*10,
      size:Math.random()*6+4,
      color:`hsl(${Math.random()*360},100%,50%)`,
      gravity:0.2,
      life:220
    });
  }
  animateConfetti();
}

function animateConfetti(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=confetti.length-1;i>=0;i--){
    let c=confetti[i];
    c.vy+=c.gravity;
    c.x+=c.vx;
    c.y+=c.vy;
    c.life--;
    ctx.fillStyle=c.color;
    ctx.fillRect(c.x,c.y,c.size,c.size);
    if(c.life<=0) confetti.splice(i,1);
  }
  if(confetti.length>0) requestAnimationFrame(animateConfetti);
}

/* ================= MUSIC ================= */

function fadeMusicIn(){
  const music=document.getElementById("bgMusic");
  music.volume=0;
  music.play().catch(()=>{});
  let fade=setInterval(()=>{
    if(music.volume<0.5) music.volume+=0.02;
    else clearInterval(fade);
  },200);
}

</script>
</body>
</html>
